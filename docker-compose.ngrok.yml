# ngrok override for docker-compose.yml
# This file configures Traefik to accept ngrok hostnames

services:
  # ngrok backend configuration
  backend:
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`frederick-api-dev.ngrok.io`) || Host(`api.mapmoji.app`)"
      - "traefik.http.services.backend.loadbalancer.server.port=3000"
      - "traefik.http.routers.backend.tls=false" # Disable SSL for ngrok
      - "traefik.http.routers.backend.middlewares=backend-headers"
      - "traefik.http.middlewares.backend-headers.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,PATCH,OPTIONS"
      - "traefik.http.middlewares.backend-headers.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.backend-headers.headers.accesscontrolallowheaders=*"

  # ngrok websocket configuration
  websocket:
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.websocket.rule=Host(`frederick-ws-dev.ngrok.io`) || Host(`ws.mapmoji.app`)"
      - "traefik.http.services.websocket.loadbalancer.server.port=8081"
      - "traefik.http.routers.websocket.tls=false" # Disable SSL for ngrok
      - "traefik.http.routers.websocket.middlewares=websocket-headers"
      - "traefik.http.middlewares.websocket-headers.headers.accesscontrolallowmethods=GET,POST,OPTIONS"
      - "traefik.http.middlewares.websocket-headers.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.websocket-headers.headers.accesscontrolallowheaders=*"

  # ngrok filter-processor configuration
  filter-processor:
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.filter-processor.rule=Host(`frederick-filter-dev.ngrok.io`) || Host(`filter.mapmoji.app`)"
      - "traefik.http.services.filter-processor.loadbalancer.server.port=8082"
      - "traefik.http.routers.filter-processor.tls=false" # Disable SSL for ngrok

  # ngrok web-dashboard configuration with development settings
  web-dashboard:
    build:
      context: .
      dockerfile: apps/web-dashboard/Dockerfile.dev
    environment:
      - NODE_ENV=development
      - PORT=3001
    volumes:
      - ./apps/web-dashboard:/app/apps/web-dashboard
      - /app/apps/web-dashboard/node_modules
    command: pnpm dev
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`frederick-dashboard-dev.ngrok.io`) || Host(`dashboard.mapmoji.app`)"
      - "traefik.http.services.dashboard.loadbalancer.server.port=3001"
      - "traefik.http.routers.dashboard.tls=false" # Disable SSL for ngrok
